<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quáº£n lÃ½ sinh viÃªn - Hiá»‡n Ä‘áº¡i</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/Module1/CSS/style.css">
</head>
<body>
    
    <div class="container">
        <h2>ğŸ“š Quáº£n lÃ½ sinh viÃªn</h2>

        <div class="add-student-form">
            <h3>ThÃªm Sinh ViÃªn Má»›i</h3>
            <label for="name">Nháº­p há» vÃ  tÃªn:
                <input type="text" id="name" name="name" placeholder="VÃ­ dá»¥: Nguyá»…n VÄƒn A">
            </label>
            <label for="class">Chá»n lá»›p:
                <select id="class" name="class"></select>
            </label><br>
            <div class="score-inputs">
                <label for="maths">
                    <span>Äiá»ƒm ToÃ¡n:</span>
                    <input type="number" id="maths" name="maths" placeholder="0 - 10" min="0" max="10" step="0.1">
                </label>
                <label for="physics">
                    <span>Äiá»ƒm LÃ½:</span>
                    <input type="number" id="physics" name="physics" placeholder="0 - 10" min="0" max="10" step="0.1">
                </label>
                <label for="chemistry">
                    <span>Äiá»ƒm HÃ³a:</span>
                    <input type="number" id="chemistry" name="chemistry" placeholder="0 - 10" min="0" max="10" step="0.1">
                </label>
            </div>
            <hr>
            
            <script>
    

                // Hiá»ƒn thá»‹ sinh viÃªn cÃ³ Ä‘iá»ƒm trung bÃ¬nh cao nháº¥t
                document.addEventListener('DOMContentLoaded', function() {
                    document.getElementById('showTopStudentBtn').onclick = function() {
                        if (students.length === 0) {
                            document.getElementById('topStudentResult').innerHTML = "ChÆ°a cÃ³ sinh viÃªn nÃ o.";
                            return;
                        }
                        let top = students.reduce((a, b) => (parseFloat(a.calculateOverallScore()) > parseFloat(b.calculateOverallScore()) ? a : b));
                        document.getElementById('topStudentResult').innerHTML = "ğŸ–ï¸ " + top.getDisplayInfo();
                    };
                    // Thá»‘ng kÃª sá»‘ lÆ°á»£ng sinh viÃªn theo lá»›p
                    document.getElementById('showClassStatsBtn').onclick = function() {
                        if (students.length === 0) {
                            document.getElementById('classStatsResult').innerHTML = "ChÆ°a cÃ³ sinh viÃªn nÃ o.";
                            return;
                        }
                        let stats = {};
                        students.forEach(s => {
                            stats[s.className] = (stats[s.className] || 0) + 1;
                        });
                        let html = "<ul>";
                        for (let cls in stats) {
                            html += `<li>Lá»›p ${cls}: ${stats[cls]} sinh viÃªn</li>`;
                        }
                        html += "</ul>";
                        document.getElementById('classStatsResult').innerHTML = html;
                    };
                });
            </script>
            <button id="addStudentBtn">â• ThÃªm sinh viÃªn</button>
        </div>
<div class="extra-interface">
                <h3>ğŸ“ Thá»‘ng kÃª nhanh</h3>
                <button id="showTopStudentBtn">Hiá»ƒn thá»‹ sinh viÃªn Ä‘iá»ƒm cao nháº¥t</button>
                <div id="topStudentResult"></div>
            </div>
            <div class="extra-interface">
                <h3>ğŸ“Š Thá»‘ng kÃª lá»›p</h3>
                <button id="showClassStatsBtn">Thá»‘ng kÃª sá»‘ lÆ°á»£ng sinh viÃªn theo lá»›p</button>
                <div>
                    <a href="ã‚¯ãƒ©ã‚¹ã®ç®¡ç†.html">Quáº£n lÃ½ lá»›p há»c</a>
                </div>
                <div id="classStatsResult"></div>
            </div>
        <hr>

        <div id="studentList">
            <h3>Danh sÃ¡ch Sinh ViÃªn:</h3>
            <ul id="studentsUl"></ul>
        </div>

        <hr>

        <div>
            <h3>ğŸ” TÃ¬m kiáº¿m Sinh ViÃªn theo TÃªn:</h3>
            <div class="search-container">
                <input type="text" id="searchName" placeholder="Nháº­p tÃªn sinh viÃªn Ä‘á»ƒ tÃ¬m kiáº¿m">
                <button id="searchBtn">TÃ¬m kiáº¿m</button>
            </div>
            <div id="searchResults"></div>
        </div>
    </div>
    

   <script>
    // --- KHAI BÃO HÃ€M LOCAL STORAGE VÃ€ Dá»® LIá»†U ---

    function saveToLocalStorage(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    }

    function loadFromLocalStorage(key, mapFunction = null) {
        const storedData = localStorage.getItem(key);
        if (storedData) {
            const parsedData = JSON.parse(storedData);
            // Ãp dá»¥ng mapFunction náº¿u cÃ³ (dÃ¹ng Ä‘á»ƒ tÃ¡i táº¡o Ä‘á»‘i tÆ°á»£ng Student)
            return mapFunction ? parsedData.map(mapFunction) : parsedData;
        }
        return [];
    }

    // --- KHAI BÃO CLASS VÃ€ Dá»® LIá»†U CHÃNH ---

    if(localStorage.getItem('registeredEmail') === null || localStorage.getItem('registeredPassword') === null){
        alert('Báº¡n chÆ°a Ä‘Äƒng kÃ½ tÃ i khoáº£n. Vui lÃ²ng Ä‘Äƒng kÃ½ trÆ°á»›c khi sá»­ dá»¥ng há»‡ thá»‘ng.');
        window.location.href = "signup.html"; 
    }

    class Student{
        constructor(name, className, age, address, math, physics, chemistry){
            this.name = name;
            this.className = className;
            this.age = age;
            this.address = address;
            this.math = parseFloat(math) || 0;
            this.physics = parseFloat(physics) || 0;
            this.chemistry = parseFloat(chemistry) || 0;
        }
        
        getName(){ return this.name; }
        getClassName(){ return this.className; }
        getAge(){ return this.age; }
        getAddress(){ return this.address; }

        calculateOverallScore(){
            const sum = this.math + this.physics + this.chemistry;
            return (sum / 3).toFixed(2); 
        }

        getDisplayInfo(){
            const overallScore = this.calculateOverallScore();
            return `${this.getName()} - Lá»›p ${this.getClassName()} (${this.getAge()} tuá»•i). ÄTB: ${overallScore}`;
        }
    }
    
    // Táº£i dá»¯ liá»‡u lá»›p há»c vÃ  sinh viÃªn
    let classes = loadFromLocalStorage('classes'); 
    let students = loadFromLocalStorage('students', data => 
        new Student(data.name, data.className, data.age, data.address, data.math, data.physics, data.chemistry)
    ); 

    // HÃ m kiá»ƒm tra Ä‘á»‹nh dáº¡ng tÃªn sinh viÃªn
                function validateStudentName(name) 
                {
    // TÃªn gá»“m Ã­t nháº¥t 2 tá»«, má»—i tá»« báº¯t Ä‘áº§u báº±ng chá»¯ hoa, chá»‰ chá»©a chá»¯ cÃ¡i vÃ  khoáº£ng tráº¯ng
                     const regex = /^([A-ZÃ€ÃÃ‚ÃƒÃˆÃ‰ÃŠÃŒÃÃ’Ã“Ã”Ã•Ã™ÃšÄ‚ÄÄ¨Å¨Æ Æ¯áº -á»´][a-zÃ Ã¡Ã¢Ã£Ã¨Ã©ÃªÃ¬Ã­Ã²Ã³Ã´ÃµÃ¹ÃºÄƒÄ‘Ä©Å©Æ¡Æ°áº¡-á»µ]+)(\s+[A-ZÃ€ÃÃ‚ÃƒÃˆÃ‰ÃŠÃŒÃÃ’Ã“Ã”Ã•Ã™ÃšÄ‚ÄÄ¨Å¨Æ Æ¯áº -á»´][a-zÃ Ã¡Ã¢Ã£Ã¨Ã©ÃªÃ¬Ã­Ã²Ã³Ã´ÃµÃ¹ÃºÄƒÄ‘Ä©Å©Æ¡Æ°áº¡-á»µ]+)+$/;
                    return regex.test(name);
                }

    // --- LOGIC HIá»‚N THá»Š VÃ€ Äá»’NG Bá»˜ Lá»šP Há»ŒC ---

    // HÃ m cáº­p nháº­t cÃ¡c option trong tháº» <select> Lá»›p há»c
   function updateClassSelect() {
    const classSelect = document.getElementById('class');
    classSelect.innerHTML = ''; 
    
    // CÃ¡c lá»›p máº·c Ä‘á»‹nh luÃ´n cÃ³ trong danh sÃ¡ch
    const defaultClasses = ["CTK42", "CTK43", "CTK44", "CTK45"];

    // 2. Láº¥y danh sÃ¡ch lá»›p duy nháº¥t tá»« máº£ng classes Ä‘Ã£ lÆ°u
    const allClassNames = new Set(classes.map(c => c.name).filter(name => name && name !== 'KhÃ´ng xÃ¡c Ä‘á»‹nh'));
    
    // ThÃªm táº¥t cáº£ cÃ¡c lá»›p máº·c Ä‘á»‹nh vÃ o Set (Set chá»‰ giá»¯ cÃ¡c giÃ¡ trá»‹ duy nháº¥t)
    defaultClasses.forEach(name => allClassNames.add(name));

    // ThÃªm cÃ¡c lá»›p tá»« sinh viÃªn Ä‘Ã£ lÆ°u (phÃ²ng trÆ°á»ng há»£p lá»›p chÆ°a Ä‘Æ°á»£c lÆ°u trong máº£ng 'classes')
    students.forEach(s => {
        if (s.className && s.className !== 'KhÃ´ng xÃ¡c Ä‘á»‹nh') {
            allClassNames.add(s.className);
        }
    });
    
    // Sáº¯p xáº¿p vÃ  thÃªm cÃ¡c lá»›p vÃ o tháº» select
    const sortedClassNames = Array.from(allClassNames).sort();

    sortedClassNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        classSelect.appendChild(option);
    });
    
    // Chá»n lá»›p Ä‘áº§u tiÃªn lÃ m máº·c Ä‘á»‹nh
    if (sortedClassNames.length > 0) {
        classSelect.value = sortedClassNames[0];
    }
}

    function updateStudentList(){
        let studentsUl = document.getElementById("studentsUl");
        studentsUl.innerHTML = "";
        if (students.length === 0) {
            studentsUl.innerHTML = '<li style="background: #fff3cd; border-color: #ffc107;">Danh sÃ¡ch trá»‘ng. Vui lÃ²ng thÃªm sinh viÃªn.</li>';
            return;
        }
        for(let student of students){
            let li = document.createElement("li");
            li.textContent = student.getDisplayInfo();
            studentsUl.appendChild(li);
        }
        updateStats(); 
    }
    
    function validateScore(score, subjectName) {
        const num = parseFloat(score);
        if (isNaN(num) || num < 0 || num > 10) {
            alert(`Vui lÃ²ng nháº­p Ä‘iá»ƒm ${subjectName} há»£p lá»‡ (tá»« 0 Ä‘áº¿n 10).`);
            return false;
        }
        return true;
    }

    function updateStats() {
        let stats = {};
        students.forEach(s => {
            stats[s.className] = (stats[s.className] || 0) + 1;
        });
        let html = "<ul>";
        for (let cls in stats) {
            html += `<li>Lá»›p ${cls}: ${stats[cls]} sinh viÃªn</li>`;
        }
        html += "</ul>";
        document.getElementById('classStatsResult').innerHTML = students.length === 0 ? "ChÆ°a cÃ³ sinh viÃªn nÃ o." : html;
        document.getElementById('topStudentResult').innerHTML = '';
    }

    // Gáº¯n sá»± kiá»‡n cho nÃºt ThÃªm sinh viÃªn
    let addStudentBtn = document.getElementById("addStudentBtn");
    addStudentBtn.addEventListener("click", function(){
        let name = document.getElementById("name").value.trim();
        let className = document.getElementById("class").value;
        let math = document.getElementById("maths").value.trim();
        let physics = document.getElementById("physics").value.trim();
        let chemistry = document.getElementById("chemistry").value.trim();
        
        if(name === ""){
            alert("Vui lÃ²ng nháº­p há» vÃ  tÃªn sinh viÃªn.");
            return;
        }
        if (!validateStudentName(name)) {
            alert("TÃªn sinh viÃªn khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p Ä‘Ãºng Ä‘á»‹nh dáº¡ng (Ã­t nháº¥t 2 tá»«, má»—i tá»« báº¯t Ä‘áº§u báº±ng chá»¯ hoa).");
            return;
        }

        if (!validateScore(math, "ToÃ¡n") || !validateScore(physics, "LÃ½") || !validateScore(chemistry, "HÃ³a")) {
            return;
        }
        
        // 1. KIá»‚M TRA VÃ€ THÃŠM Lá»šP Má»šI VÃ€O Máº¢NG CLASSES
        const isClassExist = classes.some(c => c.name === className);
        if (!isClassExist) {
            classes.push({ name: className, teacher: 'ChÆ°a chá»‰ Ä‘á»‹nh' });
            // 2. LÆ¯U Láº I Máº¢NG CLASSES ÄÃƒ Cáº¬P NHáº¬T
            saveToLocalStorage('classes', classes);
            updateClassSelect(); // Cáº­p nháº­t tháº» select Ä‘á»ƒ thÃªm lá»›p má»›i vÃ o danh sÃ¡ch lá»±a chá»n
        }
        
        let age = Math.floor(Math.random() * 5) + 18;
        let address = `Äá»‹a chá»‰ cá»§a Lá»›p ${className}`;
        
        let newStudent = new Student(name, className, age, address, math, physics, chemistry);
        students.push(newStudent);
        
        // LÆ¯U Láº I Máº¢NG STUDENTS
        saveToLocalStorage('students', students);
        
        updateStudentList();
        
        // XÃ³a cÃ¡c trÆ°á»ng nháº­p liá»‡u
        document.getElementById("name").value = "";
        document.getElementById("maths").value = "";
        document.getElementById("physics").value = "";
        document.getElementById("chemistry").value = "";
    });

    // HÃ m tÃ¬m kiáº¿m sinh viÃªn theo tÃªn (giá»¯ nguyÃªn)
    function searchStudentByName(name){
        if (name === "") return [];
        return students.filter(student => 
            student.getName().toLowerCase().includes(name.toLowerCase())
        );
    }
    
    // Gáº¯n sá»± kiá»‡n cho nÃºt TÃ¬m kiáº¿m (giá»¯ nguyÃªn)
    let searchBtn = document.getElementById("searchBtn");
    searchBtn.addEventListener("click", function(){
        let searchName = document.getElementById("searchName").value.trim();
        let results = searchStudentByName(searchName);
        let searchResultsDiv = document.getElementById("searchResults");
        
        searchResultsDiv.innerHTML = "<h4>Káº¿t quáº£ tÃ¬m kiáº¿m:</h4>";
        
        if(results.length === 0){
            searchResultsDiv.innerHTML += "<p>KhÃ´ng tÃ¬m tháº¥y sinh viÃªn nÃ o phÃ¹ há»£p vá»›i tá»« khÃ³a: **" + searchName + "**</p>";
        }else{
            let ul = document.createElement("ul");
            for(let student of results){
                let li = document.createElement("li");
                li.textContent = student.getDisplayInfo();
                ul.appendChild(li);
            }
            searchResultsDiv.appendChild(ul);
        }
    });

    // Sá»± kiá»‡n Thá»‘ng kÃª Ä‘iá»ƒm cao nháº¥t (Cáº§n cáº­p nháº­t logic Ä‘á»ƒ sá»­ dá»¥ng hÃ m calculateOverallScore)
    document.getElementById('showTopStudentBtn').onclick = function() {
        if (students.length === 0) {
            document.getElementById('topStudentResult').innerHTML = "ChÆ°a cÃ³ sinh viÃªn nÃ o.";
            return;
        }
        let top = students.reduce((a, b) => (parseFloat(a.calculateOverallScore()) > parseFloat(b.calculateOverallScore()) ? a : b));
        document.getElementById('topStudentResult').innerHTML = "ğŸ–ï¸ " + top.getDisplayInfo();
    };

    // Táº£i danh sÃ¡ch láº§n Ä‘áº§u (cáº§n cháº¡y cáº£ updateStats)
    document.addEventListener('DOMContentLoaded', function() {
        updateClassSelect(); // CHáº Y THÃŠM HÃ€M NÃ€Y Äá»‚ Äá»’NG Bá»˜ DANH SÃCH Lá»šP
        updateStudentList();
        updateStats();
    });
</script>
</body>
</html>