<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω l·ªõp h·ªçc</title>
    <link rel="stylesheet" href="/Module1/CSS/„ÇØ„É©„Çπ.css">
</head>
<body>
    <div class="container">
        <h2>üìö Qu·∫£n l√Ω l·ªõp h·ªçc</h2>
        <button id="addClassBtn" class="details-btn">‚ûï Th√™m l·ªõp</button>
        
        <div id="classForm" style="display: none;">
            <h3 id="formTitle">Th√™m l·ªõp m·ªõi</h3>
            <label>T√™n l·ªõp: <input type="text" id="className"></label><br><br>
            <label>Gi√°o vi√™n ch·ªß nhi·ªám: <input type="text" id="teacherName"></label><br><br>
            <button id="saveClassBtn" class="details-btn">L∆∞u</button>
            <button id="cancelBtn" class="delete-btn">H·ªßy</button>
        </div>
        
        <h3>Danh s√°ch c√°c l·ªõp</h3>
        <div id="classList"></div>

        <hr>
        <div id="classDetails">
            <h3>Chi ti·∫øt L·ªõp v√† Sinh vi√™n</h3>
            <p>Ch·ªçn n√∫t "Chi ti·∫øt" b√™n c·∫°nh m·ªói l·ªõp ƒë·ªÉ xem danh s√°ch sinh vi√™n.</p>
        </div>
    </div>
    
    <script>
    // --- KHAI B√ÅO H√ÄM LOCAL STORAGE V√Ä D·ªÆ LI·ªÜU ---

    function saveToLocalStorage(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    }

    function loadFromLocalStorage(key) {
        const storedData = localStorage.getItem(key);
        return storedData ? JSON.parse(storedData) : [];
    }
    
    // T·∫£i d·ªØ li·ªáu t·ª´ Local Storage
    let classes = loadFromLocalStorage('classes');
    let students = loadFromLocalStorage('students');
    
    // N·∫øu ch∆∞a c√≥ l·ªõp n√†o, kh·ªüi t·∫°o l·ªõp m·∫∑c ƒë·ªãnh (T√πy ch·ªçn)
    if (classes.length === 0) {
        classes = [
            { id: 'ctk45', name: 'CTK45', teacher: 'ThS. Nguy·ªÖn VƒÉn A' },
            { id: 'ctk44', name: 'CTK44', teacher: 'PGS. Tr·∫ßn Th·ªã B' },
        ];
        saveToLocalStorage('classes', classes);
    }
    
    let editIndex = null;
    
    // DOM Elements
    const addClassBtn = document.getElementById('addClassBtn');
    const classForm = document.getElementById('classForm');
    const saveClassBtn = document.getElementById('saveClassBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const classNameInput = document.getElementById('className');
    const teacherNameInput = document.getElementById('teacherName');
    const classList = document.getElementById('classList');
    const classDetails = document.getElementById('classDetails');
    const formTitle = document.getElementById('formTitle');


    // H√†m ti·ªán √≠ch t√≠nh ƒëi·ªÉm trung b√¨nh
    function calculateOverallScore(math, physics, chemistry) {
        const sum = parseFloat(math || 0) + parseFloat(physics || 0) + parseFloat(chemistry || 0);
        return (sum / 3).toFixed(2); 
    }

    // --- LOGIC CRUD L·ªöP ---

    function renderClasses() {
        classList.innerHTML = '';
        classes.forEach((cls, idx) => {
            // ƒê·∫øm s·ªë SV d·ª±a tr√™n t√™n l·ªõp (cls.name)
            const studentCount = students.filter(s => s.className === cls.name).length; 
            const div = document.createElement('div');
            div.className = 'class-item';
            div.innerHTML = `
                <div>
                    <strong>${cls.name}</strong> 
                    <span style="font-size: 0.9em; color: #6c757d;">(${studentCount} Sinh vi√™n)</span>
                    <br>Gi√°o vi√™n: ${cls.teacher}
                </div>
                <div class="actions">
                    <button class="details-btn" onclick="showDetails('${cls.name}')">Chi ti·∫øt SV</button>
                    <button class="edit-btn" onclick="editClass(${idx})">S·ª≠a</button>
                    <button class="delete-btn" onclick="deleteClass(${idx})">X√≥a</button>
                </div>
            `;
            classList.appendChild(div);
        });
    }

    function resetForm() {
        classNameInput.value = '';
        teacherNameInput.value = '';
        editIndex = null;
        formTitle.textContent = 'Th√™m l·ªõp m·ªõi';
    }

    addClassBtn.onclick = () => {
        classForm.style.display = 'block';
        resetForm();
    };

    cancelBtn.onclick = () => {
        classForm.style.display = 'none';
        resetForm();
    };

    saveClassBtn.onclick = () => {
        const name = classNameInput.value.trim();
        const teacher = teacherNameInput.value.trim();
        if (!name || !teacher) {
            alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.');
            return;
        }
        
        let oldName = null;

        if (editIndex === null) {
            // Th√™m l·ªõp m·ªõi
            classes.push({ name, teacher });
        } else {
            // S·ª≠a l·ªõp
            oldName = classes[editIndex].name;
            classes[editIndex] = { name, teacher };
        }
        
        // C·∫≠p nh·∫≠t m·∫£ng students n·∫øu t√™n l·ªõp thay ƒë·ªïi
        if (oldName && oldName !== name) {
            students.forEach(s => {
                if (s.className === oldName) {
                    s.className = name;
                }
            });
            // L∆ØU L·∫†I M·∫¢NG STUDENTS ƒê√É S·ª¨A
            saveToLocalStorage('students', students); 
        }

        // L∆ØU L·∫†I M·∫¢NG CLASSES
        saveToLocalStorage('classes', classes);

        classForm.style.display = 'none';
        resetForm();
        renderClasses();
    };
    window.editStudent = (idx) => {
        const student = students[idx];
        const newMath = prompt('ƒêi·ªÉm To√°n:', student.math);
        if (newMath !== null && !isNaN(newMath) && newMath.trim() !== '') {
            student.math = parseFloat(newMath).toFixed(2);
        }
       
        const newPhysics = prompt('ƒêi·ªÉm L√Ω:', student.physics);
        if (newPhysics !== null && !isNaN(newPhysics) && newPhysics.trim() !== '') {
            student.physics = parseFloat(newPhysics).toFixed(2);
        }
        const newChemistry = prompt('ƒêi·ªÉm H√≥a:', student.chemistry);
        if (newChemistry !== null && !isNaN(newChemistry) && newChemistry.trim() !== '') {
            student.chemistry = parseFloat(newChemistry).toFixed(2);
        }
        const newName = prompt('T√™n sinh vi√™n:', student.name);
        if (newName !== null && newName.trim() !== '') {
            student.name = newName.trim();
            // L∆ØU L·∫†I M·∫¢NG STUDENTS
            saveToLocalStorage('students', students);
            renderClasses();
            showDetails(student.className); // C·∫≠p nh·∫≠t l·∫°i chi ti·∫øt l·ªõp
        }
    };
    window.editClass = (idx) => {
        editIndex = idx;
        classForm.style.display = 'block';
        classNameInput.value = classes[idx].name;
        teacherNameInput.value = classes[idx].teacher;
        formTitle.textContent = 'S·ª≠a l·ªõp';
    };

    window.deleteClass = (idx) => {
        const clsName = classes[idx].name;
        const svCount = students.filter(s => s.className === clsName).length;
        
        if (svCount > 0) {
             if (!confirm(`L·ªõp ${clsName} ƒëang c√≥ ${svCount} sinh vi√™n. X√≥a l·ªõp s·∫Ω KH√îNG x√≥a sinh vi√™n nh∆∞ng s·∫Ω g√°n h·ªç v√†o l·ªõp 'Kh√¥ng x√°c ƒë·ªãnh'. B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?`)) {
                 return;
             }
             // C·∫≠p nh·∫≠t sinh vi√™n sang l·ªõp 'Kh√¥ng x√°c ƒë·ªãnh'
             students.forEach(s => {
                 if (s.className === clsName) {
                     s.className = 'Kh√¥ng x√°c ƒë·ªãnh';
                 }
             });
             // L∆ØU L·∫†I M·∫¢NG STUDENTS ƒê√É S·ª¨A
             saveToLocalStorage('students', students); 
        } else {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªõp ${clsName}?`)) return;
        }

        classes.splice(idx, 1);
        // L∆ØU L·∫†I M·∫¢NG CLASSES
        saveToLocalStorage('classes', classes);
        
        renderClasses();
        classDetails.innerHTML = '';
    };
    //H√†m x√≥a sinh vi√™n
    window.deleteStudent = (idx, className) => {
    const studentName = students[idx].name;
    if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a sinh vi√™n ${studentName} kh·ªèi danh s√°ch? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
        // X√≥a sinh vi√™n kh·ªèi m·∫£ng
        students.splice(idx, 1);
        
        // C·∫≠p nh·∫≠t Local Storage
        saveToLocalStorage('students', students);
        
        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
        renderClasses(); // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng SV trong danh s√°ch l·ªõp
        showDetails(className); // C·∫≠p nh·∫≠t l·∫°i chi ti·∫øt l·ªõp
    }
};

    // --- LOGIC HI·ªÇN TH·ªä CHI TI·∫æT SINH VI√äN ---

  window.showDetails = (className) => {
    const clsInfo = classes.find(c => c.name === className) || { name: className, teacher: 'N/A' };
    const classStudents = students.filter(s => s.className === className); 
    
    // T√≠nh ƒëi·ªÉm trung b√¨nh l·ªõp (Gi·ªØ nguy√™n)
    let avgScore = 0;
    if (classStudents.length > 0) {
        const totalScore = classStudents.reduce((sum, s) => sum + parseFloat(calculateOverallScore(s.math, s.physics, s.chemistry)), 0);
        avgScore = (totalScore / classStudents.length).toFixed(2);
    }

    let html = `
        <h3>Chi ti·∫øt l·ªõp: ${clsInfo.name}</h3>
        <p><strong>Gi√°o vi√™n ch·ªß nhi·ªám:</strong> ${clsInfo.teacher}</p>
        <p><strong>ƒêi·ªÉm TB L·ªõp:</strong> <span style="color: #28a745; font-weight: bold;">${avgScore > 0 ? avgScore : 'N/A'}</span></p>
        <h4>Danh s√°ch Sinh vi√™n (${classStudents.length} ng∆∞·ªùi):</h4>
    `;

    if (classStudents.length === 0) {
        html += '<p style="color: #6c757d;">Ch∆∞a c√≥ sinh vi√™n n√†o trong l·ªõp n√†y.</p>';
    } else {
        classStudents.sort((a, b) => parseFloat(calculateOverallScore(b.math, b.physics, b.chemistry)) - parseFloat(calculateOverallScore(a.math, a.physics, a.chemistry)));

        const ul = classStudents.map(s => {
            const score = calculateOverallScore(s.math, s.physics, s.chemistry);
            
            // T√¨m index c·ªßa sinh vi√™n trong m·∫£ng students G·ªêC ƒë·ªÉ truy·ªÅn v√†o editStudent/deleteStudent
            // C·∫ßn t√¨m b·∫±ng nhi·ªÅu tr∆∞·ªùng ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c
            const studentIndex = students.findIndex(originalS => 
                originalS.name === s.name && 
                originalS.className === s.className && 
                originalS.math === s.math
            );

            return `
                <li class="student-item-details">
                    <div>
                        <strong>${s.name}</strong>: 
                        <span class="scores-text">
                            To√°n ${s.math}, L√Ω ${s.physics}, H√≥a ${s.chemistry}. 
                            ƒêTB: <strong>${score}</strong>
                        </span>
                    </div>
                    <div>
                        <button class="edit-btn" onclick="editStudent(${studentIndex})">S·ª≠a</button>
                        <button class="delete-btn" onclick="deleteStudent(${studentIndex}, '${className}')">X√≥a</button>
                    </div>
                </li>
            `;
        }).join('');
        html += `<ul id="studentsList">${ul}</ul>`;
    }

    classDetails.innerHTML = html;
};

// Kh·ªüi t·∫°o khi t·∫£i trang (Gi·ªØ nguy√™n)
document.addEventListener('DOMContentLoaded', renderClasses);
</script>
</body>
</html>