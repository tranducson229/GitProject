<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S√°ch</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f4f4; }
        h1 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #007bff; color: white; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        button { padding: 8px 12px; font-size: 14px; cursor: pointer; border: none; border-radius: 4px; transition: background-color 0.3s; margin-right: 5px; }
        #addBookBtn { background-color: #28a745; color: white; margin-bottom: 15px; }
        #addBookBtn:hover { background-color: #218838; }
        .borrow-btn { background-color: #ffc107; color: #333; }
        .borrow-btn:hover { background-color: #e0a800; }
        .return-btn { background-color: #17a2b8; color: white; }
        .return-btn:hover { background-color: #138496; }
        .status-available { color: green; font-weight: bold; }
        .status-unavailable { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üìö Qu·∫£n l√Ω Th∆∞ vi·ªán S√°ch</h1>
    <button id="addBookBtn">Th√™m s√°ch m·ªõi</button>
    <hr>

    <table id="bookTable">
        <thead>
            <tr>
                <th>M√£ s·ªë s√°ch</th>
                <th>T√™n s√°ch</th>
                <th>NƒÉm xu·∫•t b·∫£n</th>
                <th>S·ªë quy·ªÉn</th>
                <th>T√¨nh tr·∫°ng</th>
                <th>Thao t√°c</th> 
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        // ƒê·ªãnh nghƒ©a l·ªõp
        class Book {
            constructor(maSo, ten, namXB, soQuyen) {
                this.maSo = maSo;
                this.ten = ten;
                this.namXB = namXB;
                this.soQuyen = soQuyen;
                this.tinhTrang = this.soQuyen > 0;
                // Thu·ªôc t√≠nh m·ªõi l∆∞u tr·ªØ s·ªë l∆∞·ª£ng ban ƒë·∫ßu/t·ªëi ƒëa
                this.maxQuyen = soQuyen; 
            }
            
            // Ph∆∞∆°ng th·ª©c m∆∞·ª£n s√°ch (gi·∫£m 1)
            borrow() {
                if (this.soQuyen > 0 ) {
                    this.soQuyen--;
                    this.tinhTrang = this.soQuyen > 0;
                    return true;
                }
                return false;
            }
            
            // Ph∆∞∆°ng th·ª©c tr·∫£ s√°ch (tƒÉng 1, ƒë√£ ƒë∆∞·ª£c ki·ªÉm tra gi·ªõi h·∫°n trong handleReturn)
            returnBook() {
                this.soQuyen++;
                this.tinhTrang = true;
                return true;
            }
        }

        // D·ªØ li·ªáu m·∫´u
        const danhSachSach = [
            new Book("10001", "L·∫≠p tr√¨nh JavaScript", 2020, 5),
            new Book("20002", "H·ªçc Python c∆° b·∫£n", 2019, 3),
            new Book("30003", "C·∫•u tr√∫c d·ªØ li·ªáu v√† gi·∫£i thu·∫≠t", 2018, 0),
            new Book("40004", "Ph√°t tri·ªÉn Web v·ªõi React", 2021, 2),
            new Book("50005", "C∆° s·ªü d·ªØ li·ªáu MySQL", 2017, 4)
        ];

        // --- H√ÄM TI·ªÜN √çCH / VALIDATE ---

        function validateMaSo(maSo) {
            const regex = /^[1-5][0-9]{4}$/;
            return regex.test(maSo);
        }

        function validateNamXB(nam) {
            const num = parseInt(nam);
            const currentYear = new Date().getFullYear();
            return !isNaN(num) && num.toString().length === 4 && num <= currentYear;
        }
        
        function findBookByMaSo(maSo) {
            return danhSachSach.find(sach => sach.maSo === maSo);
        }

        // --- C√ÅC H√ÄM X·ª¨ L√ù CH·ª®C NƒÇNG ---

        function renderBookList() {
            const tableBody = document.querySelector("#bookTable tbody");
            tableBody.innerHTML = "";

            danhSachSach.forEach(sach => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = sach.maSo;
                row.insertCell(1).textContent = sach.ten;
                row.insertCell(2).textContent = sach.namXB;
                row.insertCell(3).textContent = sach.soQuyen;
                
                const tinhTrangCell = row.insertCell(4);
                tinhTrangCell.textContent = sach.tinhTrang ? "C√≤n s√°ch" : "H·∫øt s√°ch";
                tinhTrangCell.className = sach.tinhTrang ? "status-available" : "status-unavailable";

                // Th√™m c√°c n√∫t Thao t√°c
                const actionsCell = row.insertCell(5);

                const borrowBtn = document.createElement('button');
                borrowBtn.textContent = 'M∆∞·ª£n';
                borrowBtn.className = 'borrow-btn';
                borrowBtn.onclick = () => handleBorrow(sach.maSo); 
                actionsCell.appendChild(borrowBtn);

                const returnBtn = document.createElement('button');
                returnBtn.textContent = 'Tr·∫£';
                returnBtn.className = 'return-btn';
                returnBtn.onclick = () => handleReturn(sach.maSo);
                actionsCell.appendChild(returnBtn);
            });
        }

        function addBook() {
            let maSo, ten, namXB, soQuyen;

            // 1. Nh·∫≠p v√† validate M√£ s·ªë
            do {
                maSo = prompt("Nh·∫≠p m√£ s·ªë s√°ch (5 k√Ω t·ª±, b·∫Øt ƒë·∫ßu b·∫±ng 1-5):");
                if (maSo === null) return; 

                if (!validateMaSo(maSo)) {
                    alert("M√£ s·ªë s√°ch kh√¥ng h·ª£p l·ªá (VD: 1xxxx). Vui l√≤ng nh·∫≠p l·∫°i.");
                } else if (findBookByMaSo(maSo)) {
                    alert("M√£ s·ªë s√°ch ƒë√£ t·ªìn t·∫°i. Vui l√≤ng nh·∫≠p l·∫°i.");
                    maSo = null;
                }
            } while (!validateMaSo(maSo) || maSo === null || findBookByMaSo(maSo));

            // 2. Nh·∫≠p v√† validate T√™n s√°ch
            do {
                ten = prompt("Nh·∫≠p t√™n s√°ch:");
                if (ten === null) return;
                if (!ten.trim()) {
                    alert("T√™n s√°ch kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng. Vui l√≤ng nh·∫≠p l·∫°i.");
                }
            } while (!ten.trim());

            // 3. Nh·∫≠p v√† validate NƒÉm xu·∫•t b·∫£n
            do {
                namXB = prompt("Nh·∫≠p nƒÉm xu·∫•t b·∫£n (4 ch·ªØ s·ªë):");
                if (namXB === null) return;
                if (!validateNamXB(namXB)) {
                    alert(`NƒÉm xu·∫•t b·∫£n kh√¥ng h·ª£p l·ªá (4 ch·ªØ s·ªë, kh√¥ng l·ªõn h∆°n ${new Date().getFullYear()}). Vui l√≤ng nh·∫≠p l·∫°i.`);
                }
            } while (!validateNamXB(namXB));

            // 4. Nh·∫≠p v√† validate S·ªë quy·ªÉn
            let numQuyen;
            do {
                soQuyen = prompt("Nh·∫≠p s·ªë quy·ªÉn (>= 0):");
                if (soQuyen === null) return;
                numQuyen = parseInt(soQuyen);
                if (isNaN(numQuyen) || numQuyen < 0) {
                    alert("S·ªë quy·ªÉn kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p m·ªôt s·ªë nguy√™n l·ªõn h∆°n ho·∫∑c b·∫±ng 0.");
                }
            } while (isNaN(numQuyen) || numQuyen < 0);

            // 5. T·∫°o ƒë·ªëi t∆∞·ª£ng s√°ch v√† c·∫≠p nh·∫≠t danh s√°ch
            const newBook = new Book(maSo, ten.trim(), parseInt(namXB), numQuyen);
            danhSachSach.push(newBook);

            renderBookList();
            alert(`Th√™m s√°ch "${newBook.ten}" th√†nh c√¥ng!`);
        }

        /**
         * X·ª≠ l√Ω m∆∞·ª£n nhi·ªÅu quy·ªÉn, ki·ªÉm tra s·ªë l∆∞·ª£ng hi·ªán c√≥.
         */
        function handleBorrow(maSo) {
            const book = findBookByMaSo(maSo);
            if (!book) return; 

            let quantity;
            let input;
            if(book.soQuyen === 0) {
                alert("ƒê√£ h·∫øt s√°ch");
                return;
            }
            // V√≤ng l·∫∑p y√™u c·∫ßu nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá
            do {
                input = prompt(`B·∫°n mu·ªën m∆∞·ª£n bao nhi√™u quy·ªÉn s√°ch "${book.ten}"? `);
                if (input === null) return; // H·ªßy b·ªè
                
                quantity = parseInt(input);
                
                if (isNaN(quantity) || quantity <= 0) {
                    alert("S·ªë l∆∞·ª£ng m∆∞·ª£n ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng.");
                
                } else {
                    break;
                }
            } while (true);

            // Ti·∫øn h√†nh m∆∞·ª£n s√°ch
            for (let i = 0; i < quantity; i++) {
                book.borrow();
            }

            alert(`M∆∞·ª£n th√†nh c√¥ng ${quantity} quy·ªÉn s√°ch: ${book.ten}.`);
            renderBookList();
        }
        
       
        function handleReturn(maSo) {
            const book = findBookByMaSo(maSo); ¬†
            if (!book) return;

            let quantity;
            let input;

            do {
                input = prompt(`B·∫°n mu·ªën tr·∫£ bao nhi√™u quy·ªÉn s√°ch "${book.ten}"?`);
                if (input === null) return;
                
                quantity = parseInt(input);
                
                if (isNaN(quantity) || quantity <= 0) {
                    alert("S·ªë l∆∞·ª£ng tr·∫£ ph·∫£i l√† s·ªë nguy√™n d∆∞∆°ng.");
                } else if (book.soQuyen + quantity > book.maxQuyen) {
                    // Ki·ªÉm tra gi·ªõi h·∫°n t·ªëi ƒëa
                    alert(`Th·∫•t b·∫°i!`);
                } else {
                    break;
                }
            } while (true);
            
            book.soQuyen += quantity;
            book.tinhTrang = true;

            alert(`Tr·∫£ th√†nh c√¥ng ${quantity} quy·ªÉn s√°ch: ${book.ten}. S·ªë l∆∞·ª£ng hi·ªán t·∫°i: ${book.soQuyen}`);
            renderBookList();
        }

        
        document.getElementById("addBookBtn").addEventListener("click", addBook);

        renderBookList();
    </script>

</body>
</html>